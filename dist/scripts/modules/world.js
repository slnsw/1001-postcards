"use strict";define(["require","jquery","utils","three","tween","base/libs/prod/events/threex.domevents","base/libs/dev/orbit/orbit"],function(e,t,n,r,a){return function(e,i){var s;return{app:{},scene:{},camera:{},renderer:{},light:{},events:{},controls:{},settings:{fov:75,aspect:0,pw:0,ph:0,displacement:{enabled:!1,x:.5,z:.5},"interface":{near:0,far:0},frustrum:{near:1,far:500}},storage:{meshes:[]},container:t("#world"),init:function(a,i){s=this,n.attachBackboneEvents(s),s.app=a,s.container=s.app.container.find(s.container),s.listenTo(s,"meshes:created",s.addMeshes),s.app.listenTo(s,"meshes:added",s.app.post);var o=new t.Deferred;o.done(i),s.settings.aspect=e.innerWidth/(.9*e.innerHeight);var c=s.scene=new r.Scene,p=s.camera=new r.PerspectiveCamera(s.settings.fov,s.settings.aspect,s.settings.frustrum.near,s.settings.frustrum.far);p.position.set(0,0,20);var d=s.light=new r.AmbientLight(16777215);c.add(d);var m=s.renderer=new r.WebGLRenderer({devicePixelRatio:e.devicePixelRatio||1});m.setSize(e.innerWidth,.9*e.innerHeight);s.events=new THREEx.DomEvents(s.camera,s.renderer.domElement);return s.settings["interface"].near=s.camera.position.z-5,s.settings["interface"].far=2,o.resolve(),o},render:function(){s.container.append(s.renderer.domElement),e.requestAnimationFrame(s.requestAnimationFrame)},requestAnimationFrame:function(t){s.renderer.render(s.scene,s.camera),e.requestAnimationFrame(s.requestAnimationFrame)},create:function(){var e=s.getPerspectiveDimensions(s.camera.position.z,s.settings.fov,s.settings.aspect);s.settings.pw=e[0],s.settings.ph=e[1],s.createMeshes()},createMeshes:function(){var e=s.app.xml.output=n.shuffle(s.app.xml.output);if(e)for(var t in e)s.createMesh(e[t],t==e.length-1)},createMesh:function(e,t){var n=i.createElement("img"),t=t||!1;!function(e,n){n.onload=function(){var a,i,o,c,p=n.width/100,d=n.height/100;a=new r.PlaneGeometry(p,d,1),o=new r.Texture(n),i=new r.MeshLambertMaterial({side:r.DoubleSide,map:o}),i.transparent=!0,i.opacity=.3,c=new r.Mesh(a,i),o.needsUpdate=!0,s.attachDOMEvents(c),s.app.store(c,e),s.storage.meshes.push(c),t&&s.trigger("meshes:created")},n.src=e.img_url}(e,n)},addMeshes:function(){var e=s.storage.meshes,t=[],r=[],a=[],i=s.settings.pw/2-4,o=s.settings.ph/2-4,c=-i,p=i,d=-o,m=o,v=0,h=c,f=d,l=v;if(e){for(var g in e){var u=e[g],x=u.geometry.parameters.width,y=u.geometry.parameters.height;n.isGreater(h+x,p)&&(h=c,r.push(t),t=[],n.isGreater(f+y,m)&&(f=d,a.push(r),r=[],l-=2));var w=t.length,b=t.length-1,z=n.getMatrixValue(t,b);if(z){var M=z.geometry.parameters.width;h+=M/2+x/2}var F=r.length-1,E=n.getMatrixValue(r,[F,w]);if(E){var C=E.geometry.parameters.height,D=E.position.y;f=D+(C/2+y/2)}u.position.x=h,u.position.y=f,u.position.z=l,s.settings.displacement.enabled&&n.getRandomInt()%2&&(u.position.x-=s.settings.displacement.x,u.position.z-=s.settings.displacement.z),u.needsUpdate=!0,t.push(u)}a.push(r)}for(var g in a)for(var P in a[g])for(var q in a[g][P])s.scene.add(a[g][P][q]);s.trigger("meshes:added")},calibrateCoords:function(e,t,n,r,a){e=e<-(a[0]/2)?-(a[0]/2):e>a[0]/2?a[0]/2:e,t=t<-(a[1]/2)?-(a[1]/2):t>a[1]/2?a[1]/2:t;var i=e-s.settings.mw/2,o=e+s.settings.mw/2;for(var c in r){var p=r[c].split(":"),d=parseFloat(p[0]),m=parseFloat(p[1]),v=parseFloat(p[2]);if(d+s.settings.mw/2>=i&&d-s.settings.mw/2<=o&&m==t&&v==n)return s.calibrateCoords(e+s.settings.displacement.x,t,n+s.settings.displacement.z,r,a)}return e+":"+t+":"+n},filter:function(e){var t=s.app.fetch(e),n=s.app.cache("meshes");for(var r in n){var i=n[r].get("mesh"),o=i.position.z===s.settings["interface"].near?!0:!1;a.to([i.position,i.material],1,{x:i["static"].position.x,y:i["static"].position.y,z:i["static"].position.z,opacity:.3}),o&&s.overlay("",0,0,0,!0)}var c=[];t||s.app.alert("Unfortunately there aren't any images for the filter you have selected.");for(var p in t){var i=t[p].get("mesh");i["static"]={};var d=i.position.x,m=i.position.y,v=i.position.z,h=s.getPerspectiveDimensions(s.settings["interface"].near,s.settings.fov,s.settings.aspect),f=s.calibrateCoords(d,m,0,c,h);if(c.push(f),f){var l=f.split(":"),g=parseFloat(l[0]),u=parseFloat(l[1]),x=parseFloat(l[2]);i["static"].position={x:g,y:u,z:v},i["static"].offset=x;a.to([i.position,i.material],1,{x:g,y:u,z:s.settings["interface"].far+x,opacity:1})}}s.app.cache("meshes",t)},toggle:function(e){var t=s.app.cache("meshes");for(var n in t){var r,i=t[n].get("mesh"),o=i.position.z===s.settings["interface"].near?!0:!1;if(o)a.to([i.position],1,{x:i["static"].position.x,y:i["static"].position.y,z:s.settings["interface"].far+i["static"].offset}),s.overlay("",0,0,0,!0);else if(i===e){var c=a.to([e.position],1,{x:0,y:0,z:s.settings["interface"].near}),r=t[n].get("node");c.eventCallback("onComplete",function(){var t=s.getScreenCoordsOfMesh(e),n=t[0].split(":"),a=t[1].split(":"),i=n[0],o=s.renderer.context.canvas.height-(s.renderer.context.canvas.height-n[1])+1,c=a[0]-n[0]+1;s.overlay('<div><a href="'+r.album_url+'" target="_blank">'+r.img_caption+"</a></div>",i,o,c,!0)})}}},overlay:function(e,n,r,a,i){i&&s.container.find(".overlay").remove().end().append(t("<div></div>",{"class":"overlay"})),e.length>0&&s.container.find(".overlay").css({left:n+"px",bottom:r+"px","max-width":a+"px"}).html(e)},attachDOMEvents:function(e){s.events.addEventListener(e,"click",s.app.toggle,!1)},getPerspectiveDimensions:function(e,t,n){var r=Math.floor(2*e*Math.tan(.5*t*(Math.PI/180))),a=Math.floor(r*n);return[a,r]},getScreenCoordsOfMesh:function(e){var t=.5*s.renderer.context.canvas.width,n=.5*s.renderer.context.canvas.height,r=[],a=e.geometry.clone();for(var i in a.vertices){var o=a.vertices[i];o.z=e.position.z,o.project(s.camera);var c=o.x*t+t,p=-(o.y*n)+n;r.push(c+":"+p)}return r}}}(window,document)});